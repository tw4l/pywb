<template>
  <div class="app" :class="{expanded: showTimelineView}" data-app="webrecorder-replay-app">
    <div class="banner">
      <div class="banner-line">
        <div class="logo"><a href="/"><img :src="config.logoImg"/></a></div>
        <div class="snapshot-url">
          <form @submit="gotoUrl">
            <input id="theurl" type="text" :value="config.url"></input>
          </form>
        </div>
        <div class="toggles">
          <button
            class="btn btn-light btn-sm"
            :class="{active: showFullView}"
            :aria-pressed="(showFullView ? true : false)"
            @click="showFullView = !showFullView"
            :title="(showTimelineView ? _('show calendar'):_('hide calendar'))">
            <img src="/static/calendar-icon.png" />
          </button>
          <button
            class="btn btn-light btn-sm"
            :class="{active: showTimelineView || showFullView }"
            :aria-pressed="(showTimelineView || showFullView ? true : false)"
            :disabled="showFullView"
            @click="showTimelineView = !showTimelineView"
            :title="(showTimelineView ? _('show timeline'):_('hide timeline'))">
            <img src="/static/timeline-icon.png" />
          </button>
          <ul class="lang-select" role="listbox" :aria-activedescendant="config.locale"
            :aria-labelledby="_('Language select')">
            <li v-for="(locPath, key) in config.allLocales" role="option" :id="key">
              <a :href="locPath + (currentSnapshot ? currentSnapshot.id : '*') + '/' + config.url">{{ key }}</a>
            </li>
          </ul>
        </div>
      </div>
      <div class="snapshot-title" v-if="currentSnapshot && !showFullView">
        <span v-if="config.title">{{ config.title }}</span>
        {{_('Current Capture')}}: {{currentSnapshot.getTimeDateFormatted()}}
      </div>
      <div class="line" v-if="showFullView || (currentPeriod && showTimelineView)">
        <div class="timeline-wrap">
          <div class="breadcrumbs-wrap">
            <TimelineBreadcrumbs
              :period="currentPeriod"
              @goto-period="gotoPeriod"
            ></TimelineBreadcrumbs>
          </div>
          <Timeline
            :period="currentPeriod"
            :highlight="timelineHighlight"
            :current-snapshot="currentSnapshot"
            :max-zoom-level="maxTimelineZoomLevel"
            @goto-period="gotoPeriod"
          ></Timeline>
        </div>
      </div>
    </div>
    <CalendarYear
      v-if="showFullView && currentPeriod && currentPeriod.children.length"
      :period="currentPeriod"
      :current-snapshot="currentSnapshot"
       @goto-period="gotoPeriod">
    </CalendarYear>
  </div>
</template>

<script>
import Timeline from "./components/Timeline.vue";
import TimelineBreadcrumbs from "./components/TimelineBreadcrumbs.vue";
import CalendarYear from "./components/CalendarYear.vue";

import { PywbSnapshot, PywbPeriod } from "./model.js";
import {PywbI18N} from "./i18n";

export default {
  name: "PywbReplayApp",
  //el: '[data-app="webrecorder-replay-app"]',
  data: function() {
    return {
      snapshots: [],
      currentPeriod: null,
      currentSnapshot: null,
      msgs: [],
      showFullView: true,
      showTimelineView: true,
      maxTimelineZoomLevel: PywbPeriod.Type.day,
      config: {
        title: "",
        initialView: {}
      },
      timelineHighlight: false,
      locales: [],
    };
  },
  components: {Timeline, TimelineBreadcrumbs, CalendarYear},
  mounted: function() {
  },
  computed: {
    sessionStorageUrlKey() {
      // remove http(s), www and trailing slash
      return 'zoom__' + this.config.url.replace(/^https?:\/\/(www\.)?/, '').replace(/\/$/, '');
    }
  },
  methods: {
    _(id, embeddedVariableStrings=null) {
      return PywbI18N.instance.getText(id, embeddedVariableStrings);
    },
    gotoPeriod: function(newPeriod, onlyZoomToPeriod) {
      if (this.timelineHighlight) {
        setTimeout((() => {
          this.timelineHighlight=false;
        }).bind(this), 3000);
      }
      // only go to snapshot if caller did not request to zoom only
      if (newPeriod.snapshot && !onlyZoomToPeriod) {
        this.gotoSnapshot(newPeriod.snapshot, newPeriod, true /* reloadIFrame */);
      } else {
        // save current period (aka zoom)
        // use sessionStorage (not localStorage), as we want this to be a very temporary memory for current page tab/window and no longer; NOTE: it serves when navigating from an "*" query to a specific capture and subsequent reloads
        if (window.sessionStorage) {
          window.sessionStorage.setItem(this.sessionStorageUrlKey, newPeriod.fullId);
        }
        // If new period goes beyond allowed max level
        if (newPeriod.type > this.maxTimelineZoomLevel) {
          this.currentPeriod = newPeriod.get(this.maxTimelineZoomLevel);
        } else {
          this.currentPeriod = newPeriod;
        }
      }
    },
    gotoSnapshot(snapshot, fromPeriod, reloadIFrame=false) {
      this.currentSnapshot = snapshot;

      // if the current period doesn't match the current snapshot, update it
      if (fromPeriod && !this.currentPeriod.contains(fromPeriod)) {
        const fromPeriodAtMaxZoomLevel = fromPeriod.get(this.maxTimelineZoomLevel);
        if (fromPeriodAtMaxZoomLevel !== this.currentPeriod) {
          this.currentPeriod = fromPeriodAtMaxZoomLevel;
        }
      }

      // update iframe only if the snapshot was selected from the calendar/timeline.
      // if the change originated from a user clicking a link in the iframe, emitting
      // snow-shapshot will only cause a flash of content
      if (reloadIFrame !== false) {
        this.$emit("show-snapshot", snapshot);
      }
      this.showFullView = false;
      this.showTimelineView = false;
    },
    gotoUrl(event) {
      event.preventDefault();
      const newUrl = document.querySelector("#theurl").value;
      if (newUrl !== this.url) {
        window.location.href = this.config.prefix + "*/" + newUrl;
      }
    },
    setData(/** @type {PywbData} data */ data) {

      // data-set will usually happen at App INIT (from parent caller)
      this.$set(this, "snapshots", data.snapshots);
      this.$set(this, "currentPeriod", data.timeline);

      // get last-saved current period from previous page/app refresh (if there was such)
      if (window.sessionStorage) {
        const currentPeriodId = window.sessionStorage.getItem(this.sessionStorageUrlKey);
        if (currentPeriodId) {
          const newCurrentPeriodFromStorage = this.currentPeriod.findByFullId(currentPeriodId);
          if (newCurrentPeriodFromStorage) {
            this.currentPeriod = newCurrentPeriodFromStorage;
          }
        }
      }

      // signal app is DONE setting and rendering data; ON NEXT TICK
      this.$nextTick(function isDone() {
        this.$emit('data-set-and-render-completed');
      }.bind(this));
    },
    setSnapshot(view) {
      // turn off calendar (aka full) view
      this.showFullView = false;

      // convert to snapshot object to support proper rendering of time/date
      const snapshot = new PywbSnapshot(view, 0);

      // set config current URL and title
      this.config.url = view.url;
      this.config.title = view.title;

      this.gotoSnapshot(snapshot);
    }
  }
};
</script>

<style scoped>
  .app {
    font-family: Calibri, Arial, sans-serif;
    border-bottom: 1px solid lightcoral;
    width: 100%;
  }
  .app.expanded {
    height: 150px;
  }
  .full-view {
    /*position: fixed;*/
    /*top: 150px;*/
    left: 0;
  }
  .iframe iframe {
    width: 100%;
    height: 80vh;
  }
  .logo {
    width: 180px;
  }
  .banner {
    margin-top: 10px;
    width: 100%;
    max-width: 1200px; /* limit width */
    position: relative;
  }
  .line {
    display: flex;
    justify-content: center;
  }
  .banner-line {
    display: flex;
    align-items: center;
    justify-content: space-evenly;
  }

  .banner .logo {
    flex-shrink: initial;
    /* for any content/image inside the logo container */
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .banner .logo img {
    flex-shrink: 1;
  }

  .banner .timeline-wrap {
    display: flex;
    align-items: center;
    justify-content: center;
    max-width: 800px;
  }

  .timeline-wrap .line .breadcrumbs-wrap {
    display: inline-block;
    flex-grow: 1;
  }
  .toggles {
    display: flex;
    align-items: center;
  }

  .toggles button {
    margin-left: 5px;
  }

  .toggles button img {
    height: 20px;
  }

  .snapshot-url {
    display: flex;
    align-items: center;
    text-align: center;
    font-weight: bold;
    font-size: 16px;
  }
  .snapshot-title {
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #theurl {
    width: 500px;
  }

  ul.lang-select {
    display: flex;
    align-items: center;
    list-style-type: none;
    margin-bottom: 0;
  }

  ul.lang-select li {
    display: inline-block;
    padding: 0 2px 0 2px;
    font-weight: bold;
    font-size: smaller;
  }

  ul.lang-select li:not(:last-child):after {
    content: ' / ';
  }

  ul.lang-select a:link,
  ul.lang-select a:visited,
  ul.lang-select a:active {
    text-decoration: none;
  }

  ul.lang-select a:hover {
    text-decoration: underline;
  }

</style>
